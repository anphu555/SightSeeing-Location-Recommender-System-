<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kết quả tìm kiếm - exSighting</title>
    <link rel="stylesheet" href="src/css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>

    <header class="navbar-v3">
        <div class="logo" onclick="window.location.href='index.html'" style="cursor: pointer;">
            <i class="fas fa-umbrella"></i>
            <span>exSighting</span>
        </div>
        <nav class="nav-links">
            <a href="#" class="nav-item">Contact</a>
            <a href="#" class="nav-item">About us</a>
        </nav>
        
        <div id="authSection">
            <button class="user-actions-unsigned-in" id="unsignedBlock" onclick="window.location.href='login.html'">
                <div class="user-icon-bg"><i class="fas fa-user-circle"></i></div>
                <span class="sign-in-text">Sign In</span>
            </button>

            <div class="user-actions-signed-in" id="signedBlock" style="display: none;">
                <button class="user-profile-toggle">
                    <div class="user-icon-bg"><i class="fas fa-user-circle"></i></div>
                    <span class="username-text" id="displayUsername">User</span>
                    <i class="fas fa-caret-down"></i>
                </button>
                <div class="user-dropdown-menu">
                    <a href="#">Profile</a>
                    <a href="#">Settings</a>
                    <a href="#" id="btnLogout">Log Out</a>
                </div>
            </div>
        </div>
    </header>

    <section class="hero-banner" style="background-image: url('https://images.unsplash.com/photo-1528127269322-539801943592?q=80&w=2070');"> 
        <div class="overlay"></div>
        <div class="search-container">
            <h1>What type of place would you like to go?</h1>
            <div class="search-box">
                <input type="text" id="resultsPageInput" placeholder="For example: the mountains, the beaches,...">
                <button id="resultsPageSearchBtn"><i class="fas fa-search"></i></button>
            </div>
        </div>
    </section>
    
    <main class="results-page-wrapper">
        <div class="results-container">
            
            <div class="results-toolbar">
                <h3 class="result-count"><span id="totalCount">0</span> results</h3>
                
                <div class="custom-sort-dropdown" id="customSort">
                    <div class="sort-trigger">
                        <span class="sort-label">Sort by:</span>
                        <span class="sort-value" id="currentSortValue">Newest</span>
                        <i class="fas fa-chevron-down arrow-icon"></i>
                    </div>
                    <ul class="sort-options">
                        <li class="sort-option active" data-value="newest"><i class="fas fa-clock"></i> Newest</li>
                        <div class="divider"></div>
                        <li class="sort-option" data-value="price"><i class="fas fa-tag"></i> Price</li>
                        <div class="divider"></div>
                        <li class="sort-option" data-value="views"><i class="fas fa-eye"></i> Most Viewed</li>
                    </ul>
                </div>
            </div>

            <div class="results-grid" id="resultsGrid">
                </div>

        </div>
    </main>

    <script>
        const API_BASE = 'http://localhost:8000/api/v1';

        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            handleRouting();
            initSortDropdown();
        });

        // 1. AUTH LOGIC (Dùng chung)
        function checkAuth() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('username');
            const unsigned = document.getElementById('unsignedBlock');
            const signed = document.getElementById('signedBlock');
            
            if (token && user) {
                document.getElementById('displayUsername').textContent = user;
                unsigned.style.display = 'none';
                signed.style.display = 'flex';
            } else {
                unsigned.style.display = 'flex';
                signed.style.display = 'none';
            }

            const logoutBtn = document.getElementById('btnLogout');
            if(logoutBtn) {
                logoutBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    localStorage.clear();
                    window.location.reload();
                });
            }
        }

        // 2. ROUTING & DATA FETCHING
        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            const mode = params.get('mode');
            const q = params.get('q');
            
            const input = document.getElementById('resultsPageInput');
            const btn = document.getElementById('resultsPageSearchBtn');

            // Set input value nếu có q
            if(q) input.value = q;

            // Gọi API Backend
            fetchData(mode, q);

            // Bắt sự kiện tìm kiếm lại
            function doSearch() {
                const val = input.value.trim();
                if(val) fetchData(null, val);
            }
            btn.addEventListener('click', doSearch);
            input.addEventListener('keypress', (e) => { if(e.key==='Enter') doSearch(); });
        }

        async function fetchData(mode, query) {
            const grid = document.getElementById('resultsGrid');
            const count = document.getElementById('totalCount');
            grid.innerHTML = '<p style="text-align:center;width:100%">Loading...</p>';

            // Dữ liệu Fallback (Nếu backend chưa sẵn sàng)
            const mockData = [
                { id: 101, title: "HA LONG BAY", subtitle: "Quang Ninh", views: 999, image: "https://images.unsplash.com/photo-1528127269322-539801943592?q=80&w=2070" },
                { id: 102, title: "NHA TRANG", subtitle: "Khanh Hoa", views: 850, image: "https://images.unsplash.com/photo-1565691668615-5e60d5c08611?q=80&w=2070" },
                { id: 103, title: "SAPA", subtitle: "Lao Cai", views: 720, image: "https://images.unsplash.com/photo-1599229062397-6c8418047918?q=80&w=2070" },
                { id: 104, title: "DA LAT", subtitle: "Lam Dong", views: 680, image: "https://images.unsplash.com/photo-1596328372690-e9b46571b402?q=80&w=2070" },
                { id: 105, title: "HOI AN", subtitle: "Quang Nam", views: 900, image: "https://images.unsplash.com/photo-1557750255-c76072a7aad1?q=80&w=2070" }
            ];

            try {
                // LOGIC GỌI BACKEND (Bỏ comment khi chạy Server)
                /*
                let url = `${API_BASE}/recommend`;
                if(mode === 'popular') url = `${API_BASE}/places/popular`; // API endpoint giả định
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_text: query || "", top_k: 9 })
                });
                const data = await res.json();
                const items = data.results || data; // Tùy cấu trúc trả về
                */
                
                // Dùng Mock Data để demo ngay
                let items = mockData;
                
                // Lọc giả lập ở Frontend (Chỉ dùng khi chưa có Backend search thật)
                if(query && !mode) {
                    items = items.filter(i => i.title.toLowerCase().includes(query.toLowerCase()));
                }

                // Render
                count.innerText = items.length;
                if(items.length > 0) {
                    grid.innerHTML = items.map(item => `
                        <div class="result-card">
                            <div class="card-img-top">
                                <img src="${item.image}" alt="${item.title}">
                                <div class="view-badge"><i class="fas fa-eye"></i> ${item.views || 0}</div>
                            </div>
                            <div class="card-body">
                                <h4 class="card-title">${item.title}</h4>
                                <p class="card-subtitle">${item.subtitle || ''}</p>
                            </div>
                            <div class="card-footer">
                                <button class="icon-action like-btn"><i class="fas fa-thumbs-up"></i></button>
                                <button class="icon-action dislike-btn"><i class="fas fa-thumbs-down"></i></button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = '<p class="no-result" style="width:100%;text-align:center">No results found.</p>';
                }

            } catch (err) {
                console.error("Fetch error:", err);
                grid.innerHTML = '<p class="no-result" style="width:100%;text-align:center">Error connecting to server.</p>';
            }
        }

        // 3. SORT DROPDOWN UI
        function initSortDropdown() {
            const dropdown = document.getElementById('customSort');
            const trigger = dropdown.querySelector('.sort-trigger');
            const options = dropdown.querySelectorAll('.sort-option');
            const display = document.getElementById('currentSortValue');

            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('open');
            });

            options.forEach(opt => {
                opt.addEventListener('click', () => {
                    display.innerText = opt.innerText;
                    options.forEach(o => o.classList.remove('active'));
                    opt.classList.add('active');
                    dropdown.classList.remove('open');
                    // Thêm logic gọi API sort ở đây nếu cần
                });
            });

            document.addEventListener('click', (e) => {
                if(!dropdown.contains(e.target)) dropdown.classList.remove('open');
            });
        }
    </script>
</body>
</html>