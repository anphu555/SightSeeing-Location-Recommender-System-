<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sigma-Alpha Sightseeing</title>
  <link rel="stylesheet" href="css/result.css" />
</head>

<body>

  <!-- Header -->
  <header class="header">
    <div class="overlay">
      <!-- <div class="logo">
        <img src="images/tuyu.png" alt="Logo" />
        <h1>SIGMA-ALPHA SIGHTSEEING</h1>
      </div> -->

      <a href="index.html" class="logo" style="text-decoration: none; color: inherit; display: flex; align-items: center;">
        <img src="images/tuyu.png" alt="Logo" />
        <h1>SIGMA-ALPHA SIGHTSEEING</h1>
      </a>

      <div class="search-bar">
        <input type="text" placeholder="Search locations..." />
        <button>Search</button>
      </div>
    </div>
  </header>

  <!-- Results Section -->
  <main class="results-section">
    <div class="results-header">
      <h2>3 results</h2>
      <select>
        <option>Sort by: Price</option>
        <option>Sort by: Name</option>
        <option>Sort by: Rating</option>
      </select>
    </div>

    <div class="cards">
      <div class="card">
        <img src="images/tuyu.png" alt="Ha Long Bay" />
        <p>HA LONG BAY</p>
      </div>

      <div class="card">
        <img src="images/tuyu.png" alt="Tuan Chau Park" />
        <p>TUAN CHAU PARK</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>
      
      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>

      <div class="card">
        <img src="images/yentu.jpg" alt="Yen Tu Mountain" />
        <p>YEN TU MOUNTAIN</p>
      </div>
      
    </div>
  </main>
<div class="loading-indicator">Đang tải thêm địa điểm...</div>

<!-- Accessible Modal Dialog -->
<div id="notificationModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modalTitle" aria-describedby="modalMessage" tabindex="-1">
  <div class="modal-content">
    <h2 id="modalTitle" class="modal-title"></h2>
    <p id="modalMessage" class="modal-message"></p>
    <button id="modalCloseBtn" class="modal-close-btn" type="button">OK</button>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const apiBase = 'https://cowardly-unnourishing-rigoberto.ngrok-free.dev';
  const params  = new URLSearchParams(location.search);
  
  // Lấy text tìm kiếm
  const text = (params.get('text') || '').trim();
  
  // Khởi tạo số lượng k ban đầu (mặc định 6)
  let currentK = Number(params.get('k') || '6');
  const stepK  = 6; // Mỗi lần kéo xuống sẽ tải thêm 6 cái nữa
  
  let isLoading = false; // Biến cờ để chặn gọi API nhiều lần cùng lúc
  let isFull    = false; // Biến cờ để biết đã hết dữ liệu chưa

  // Modal Elements
  const modal = document.getElementById('notificationModal');
  const modalTitle = document.getElementById('modalTitle');
  const modalMessage = document.getElementById('modalMessage');
  const modalCloseBtn = document.getElementById('modalCloseBtn');
  let previousActiveElement = null;
  let modalCallback = null;

  // Accessible Modal Functions
  function showModal(title, message, callback = null) {
    previousActiveElement = document.activeElement;
    modalCallback = callback;
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    modal.classList.add('active');
    modal.focus();
    modalCloseBtn.focus();
  }

  function hideModal() {
    modal.classList.remove('active');
    if (previousActiveElement) {
      previousActiveElement.focus();
    }
    if (modalCallback) {
      modalCallback();
      modalCallback = null;
    }
  }

  // Modal event listeners
  modalCloseBtn.addEventListener('click', hideModal);
  
  modal.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      hideModal();
    }
  });

  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      hideModal();
    }
  });

  // DOM Elements
  const headerH2      = document.querySelector('.results-header h2');
  const cardsContainer= document.querySelector('.cards');
  const loader        = document.querySelector('.loading-indicator');
  const headerInput   = document.querySelector('.search-bar input');
  const headerBtn     = document.querySelector('.search-bar button');

  // Đổ lại giá trị search vào ô input nếu có
  if (headerInput) headerInput.value = text;

  // Hàm tạo thẻ HTML cho 1 địa điểm
  function renderCard(item){
    const div = document.createElement('div');
    div.className = 'card';
    const img = document.createElement('img');
    // Lưu ý: Đảm bảo đường dẫn ảnh đúng với dữ liệu trả về hoặc dùng ảnh placeholder
    img.src = 'images/halong.jpg'; 
    img.alt = item.name;
    
    const name = document.createElement('p'); 
    name.textContent = item.name;
    
    const meta = document.createElement('p');
    meta.style.fontWeight='normal'; 
    meta.style.color='#666'; 
    // meta.style.paddingBottom='12px'; // Bỏ padding cũ để nhường chỗ cho sao
    meta.textContent = `${item.province ?? ''} • Score: ${parseFloat(item.score).toFixed(2)}`;
      // --- PHẦN MỚI: Thêm 5 ngôi sao ---
    const starContainer = document.createElement('div');
    starContainer.className = 'star-rating';
    
    // Tạo 5 ngôi sao
    for (let i = 1; i <= 5; i++) {
        const star = document.createElement('span');
        star.innerHTML = '&#9733;'; // Ký tự ngôi sao
        star.className = 'star';
        star.dataset.value = i; // Lưu giá trị 1,2,3,4,5
        star.dataset.id = item.id; // Lưu ID địa điểm
        
        // Sự kiện click
        star.onclick = (e) => handleRating(item.id, i, starContainer);
        
        starContainer.appendChild(star);
    }

    div.append(img, name, meta, starContainer);
    return div;
  }

  // --- HÀM XỬ LÝ ĐÁNH GIÁ ---
  async function handleRating(placeId, score, container) {
      const token = localStorage.getItem('token');
      if (!token) {
          showModal("Thông báo", "Bạn cần đăng nhập để đánh giá!", () => {
              window.location.href = "login.html";
          });
          return;
      }

      try {
          const apiBase = 'https://cowardly-unnourishing-rigoberto.ngrok-free.dev'; // Hoặc đường dẫn ngrok của bạn
          const res = await fetch(`${apiBase}/api/v1/user/rate`, {
              method: 'POST',
              headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}` // Gửi kèm token
              },
              body: JSON.stringify({ place_id: placeId, score: score })
          });

          if (res.ok) {
              // Cập nhật giao diện: Tô vàng các sao từ 1 đến score
              const stars = container.querySelectorAll('.star');
              stars.forEach((s, index) => {
                  if (index < score) s.classList.add('active');
                  else s.classList.remove('active');
              });
              showModal("Thành công", `Đã đánh giá ${score} sao!`);
          } else {
              if (res.status === 401) {
                  showModal("Thông báo", "Phiên đăng nhập hết hạn. Vui lòng đăng nhập lại.", () => {
                      window.location.href = "login.html";
                  });
              } else {
                  showModal("Lỗi", "Có lỗi xảy ra khi gửi đánh giá.");
              }
          }
      } catch (e) {
          console.error(e);
          showModal("Lỗi", "Không thể kết nối tới server.");
      }
  }

  // Hàm gọi API chính
  async function fetchResults(kValue, isLoadMore = false) {
    if (!text) {
      headerH2.textContent = '0 results';
      return;
    }
    
    // Nếu không phải load more (lần đầu vào), hiện trạng thái loading ở header
    if (!isLoadMore) {
      headerH2.textContent = 'Loading...';
      cardsContainer.innerHTML = ''; 
    } else {
      loader.classList.add('active'); // Hiện chữ đang tải ở dưới đáy
    }

    isLoading = true;

    try {
      const r = await fetch(`${apiBase}/api/v1/recommend`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_text: text, top_k: kValue })
      });

      if (!r.ok) throw new Error(`HTTP ${r.status}`);

      const data = await r.json();
      const items = data.results || [];

      if (!isLoadMore) {
        // --- LẦN TẢI ĐẦU TIÊN ---
        headerH2.textContent = `${items.length} results`;
        items.forEach(it => cardsContainer.appendChild(renderCard(it)));
      } else {
        // --- KHI KÉO CHUỘT (LOAD MORE) ---
        // API trả về toàn bộ danh sách từ 0 -> kValue.
        // Chúng ta chỉ cần lấy những phần tử mới chưa hiển thị.
        // Giả sử API luôn trả về cùng thứ tự, ta cắt mảng từ vị trí cũ (currentK - stepK).
        
        const oldLength = currentK - stepK; 
        const newItems = items.slice(oldLength); 

        if (newItems.length === 0) {
          isFull = true; // Không còn dữ liệu mới để tải
          loader.textContent = "Đã hiển thị hết kết quả.";
        } else {
          newItems.forEach(it => cardsContainer.appendChild(renderCard(it)));
          headerH2.textContent = `${items.length} results`; // Cập nhật tổng số
        }
      }

    } catch (e) {
      console.error(e);
      if (!isLoadMore) {
        headerH2.textContent = 'Error loading data';
        cardsContainer.innerHTML = `<div style="color:red; padding:10px">${e.message}</div>`;
      }
    } finally {
      isLoading = false;
      loader.classList.remove('active');
    }
  }

  // --- HÀM MỚI: Tải lại lịch sử đánh giá ---
  async function loadUserRatings() {
      const token = localStorage.getItem('token');
      // Nếu chưa đăng nhập thì thôi, không cần tải
      if (!token) return;

      try {
          const apiBase = 'https://cowardly-unnourishing-rigoberto.ngrok-free.dev'; // Hoặc link ngrok của bạn
          const res = await fetch(`${apiBase}/api/v1/user/my-ratings`, {
              method: 'GET',
              headers: { 
                  'Authorization': `Bearer ${token}`
              }
          });

          if (res.ok) {
              const ratingsMap = await res.json(); 
              // ratingsMap sẽ có dạng: { "1": 5, "12": 4 }
              
              // Duyệt qua tất cả các container sao đang hiển thị trên màn hình
              document.querySelectorAll('.star-rating').forEach(container => {
                  // Lấy ID địa điểm từ ngôi sao đầu tiên trong container
                  const firstStar = container.querySelector('.star');
                  if (!firstStar) return;
                  
                  const placeId = firstStar.dataset.id;
                  
                  // Kiểm tra xem ID này có trong lịch sử đánh giá không
                  if (ratingsMap[placeId]) {
                      const userScore = ratingsMap[placeId];
                      
                      // Tô màu lại các ngôi sao
                      const stars = container.querySelectorAll('.star');
                      stars.forEach((s, index) => {
                          if (index < userScore) s.classList.add('active');
                          else s.classList.remove('active');
                      });
                  }
              });
          }
      } catch (e) {
          console.error("Lỗi tải lịch sử đánh giá:", e);
      }
  }

  // Chạy lần đầu tiên
  (async () => {
        // 1. Tải danh sách địa điểm trước
        await fetchResults(currentK, false);
        
        // 2. Sau đó tải ratings đè lên
        await loadUserRatings();
    })();

  // --- XỬ LÝ INFINITE SCROLL ---
  window.addEventListener('scroll', () => {
    // Nếu đang tải hoặc đã hết dữ liệu thì không làm gì cả
    if (isLoading || isFull) return;

    // Kiểm tra nếu cuộn gần đến đáy trang (còn cách 100px)
    if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 100) {
      currentK += stepK; // Tăng số lượng k cần lấy
      fetchResults(currentK, true); // Gọi hàm với cờ isLoadMore = true
    }
  });

  // --- XỬ LÝ TÌM KIẾM MỚI ---
  function triggerSearch() {
    const q = (headerInput?.value || '').trim();
    if (!q) return;
    // Reload lại trang với từ khóa mới, reset k về mặc định
    const newParams = new URLSearchParams();
    newParams.set('text', q);
    newParams.set('k', '6'); 
    window.location.search = newParams.toString();
  }

  headerBtn?.addEventListener('click', triggerSearch);
  headerInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') triggerSearch();
  });
});
</script>

</body>
</html>
